name: Security Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for secrets
      run: |
        echo "Checking for accidentally committed secrets..."
        # Exclude workflow files, node_modules, .git, .next, build files, and env files
        if grep -r "SUPABASE_SERVICE_ROLE_KEY.*eyJ" . \
          --exclude-dir=node_modules \
          --exclude-dir=.git \
          --exclude-dir=.github \
          --exclude-dir=.next \
          --exclude=".env*" \
          --exclude="*.example" \
          --exclude="*.md" 2>/dev/null; then
          echo "⚠️ WARNING: Found potential service role key in source files!"
          echo "This key should only exist in .env files (which should NOT be committed)"
          exit 1
        fi
        if grep -r "DATABASE_URL.*postgresql://.*:.*@" . \
          --exclude-dir=node_modules \
          --exclude-dir=.git \
          --exclude-dir=.github \
          --exclude-dir=.next \
          --exclude=".env*" \
          --exclude="*.example" \
          --exclude="*.md" 2>/dev/null; then
          echo "⚠️ WARNING: Found potential database credentials in source files!"
          echo "Database URLs should only exist in .env files (which should NOT be committed)"
          exit 1
        fi
        echo "✅ No obvious secrets found in source code"
    
    - name: Check .env is not committed
      run: |
        if [ -f .env ]; then
          echo "⚠️ ERROR: .env file found in repository!"
          exit 1
        fi
        echo "✅ .env file not in repository"
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint --if-present
      
    - name: Check for vulnerable dependencies
      run: npm audit --audit-level=high
