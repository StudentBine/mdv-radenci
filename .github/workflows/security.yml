name: Security Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check for secrets
      run: |
        echo "Checking for accidentally committed secrets..."
        if grep -r "SUPABASE_SERVICE_ROLE_KEY.*eyJ" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.example"; then
          echo "⚠️ WARNING: Found potential service role key!"
          exit 1
        fi
        if grep -r "DATABASE_URL.*postgresql://.*:.*@" . --exclude-dir=node_modules --exclude-dir=.git --exclude="*.example" --exclude="*.md"; then
          echo "⚠️ WARNING: Found potential database credentials!"
          exit 1
        fi
        echo "✅ No obvious secrets found"
    
    - name: Check .env is not committed
      run: |
        if [ -f .env ]; then
          echo "⚠️ ERROR: .env file found in repository!"
          exit 1
        fi
        echo "✅ .env file not in repository"
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint --if-present
      
    - name: Check for vulnerable dependencies
      run: npm audit --audit-level=high
